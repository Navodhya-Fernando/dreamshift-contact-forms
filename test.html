<!doctype html>
<meta charset="utf-8" />
<title>Airtable Connectivity Test — Lead Magnet Form (Session upsert)</title>
<style>
  :root{--bg:#0b0b0b;--fg:#e6e6e6;--accent:#f6b900;--ink:#24101a;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--fg);padding:24px;line-height:1.4}
  h1{margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  input,select{width:330px;max-width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#171717;color:#fff}
  label{display:block;margin:10px 0 6px}
  button{background:var(--accent);border:none;color:var(--ink);font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{opacity:.9}
  pre{white-space:pre-wrap;background:#111;color:#b6ffb6;border:1px solid #333;padding:12px;border-radius:10px;min-height:160px;margin-top:10px}
  small{opacity:.7}
  .cols{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  @media (max-width:900px){.cols{grid-template-columns:1fr}}
</style>

<h1>Airtable Test — Lead Magnet Form</h1>
<small>This page creates/updates a single record per browser session using <code>SessionId</code>.</small>

<div class="row">
  <button id="btnCreate">Create Empty Row (with SessionId)</button>
  <button id="btnFind">Find By SessionId</button>
  <button id="btnReset">Reset Session</button>
</div>

<div class="cols">
  <div>
    <label>SessionId (auto)</label>
    <input id="sessionId" readonly>
  </div>
  <div>
    <label>Table</label>
    <input id="tableName" value="Lead Magnet Form">
  </div>

  <div>
    <label>First Name</label>
    <input id="firstName" placeholder="John">
  </div>
  <div>
    <label>Last Name</label>
    <input id="lastName" placeholder="Doe">
  </div>

  <div>
    <label>Email</label>
    <input id="email" placeholder="john@example.com">
  </div>
  <div>
    <label>LinkedIn</label>
    <input id="linkedin" placeholder="https://linkedin.com/in/username">
  </div>

  <div>
    <label>WhatsApp (E.164)</label>
    <input id="whatsapp" placeholder="+61412345678">
  </div>
  <div>
    <label>Currently Applying?</label>
    <select id="applying">
      <option value="">— choose —</option>
      <option value="true">Yes</option>
      <option value="false">No</option>
    </select>
  </div>

  <div>
    <label>Jobs Applying</label>
    <input id="jobsApplying" placeholder="Software Engineer, Analyst">
  </div>
  <div>
    <label>Current Job</label>
    <input id="currentJob" placeholder="Marketing Manager">
  </div>
</div>

<div class="row" style="margin-top:18px">
  <button id="btnStep1">UPSERT Step 1 (First/Last)</button>
  <button id="btnStep2">UPSERT Step 2 (Email/LinkedIn)</button>
  <button id="btnStep3">UPSERT Step 3 (WhatsApp)</button>
  <button id="btnFinal">UPSERT Final (Status + Applying + Jobs/Current)</button>
</div>

<pre id="out">Ready.</pre>

<script>
/*** Airtable Connectivity Test — FULL JS (no SourcePage) ***/

/*** CONFIG — For local testing only (do not ship PAT client-side) ***/
const AIRTABLE_API_KEY = 'patKhu6Mk04jcXvAw.87cfbb10e336f1b753651743ee7ca8d9bff68057173264af2437aad9770469ef';
const AIRTABLE_BASE_ID = 'appUH4eBIBnH4D0fX';

/*** DOM helpers ***/
const $ = sel => document.querySelector(sel);
const out = $('#out');

function log(m){ out.textContent = String(m); console.log('[TEST]', m); }
function logObj(label, obj){ log(label + '\n' + JSON.stringify(obj, null, 2)); }
function logErr(m){ out.textContent = '❌ ' + m; console.error('[TEST]', m); }

/*** Session helpers (single-record upsert by SessionId) ***/
const COUNTRY_CODE = 'AU'; // just a namespace for keys
function sessionKey(){ return `ds_session_${COUNTRY_CODE}_LMF`; }
function recordKey(){ return `ds_airtable_rec_${COUNTRY_CODE}_LMF`; }

function getSessionId(){
  let id = sessionStorage.getItem(sessionKey());
  if(!id){
    id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random()));
    sessionStorage.setItem(sessionKey(), id);
  }
  return id;
}
function setSID(){ $('#sessionId').value = getSessionId(); }
function cacheRecordId(id){ sessionStorage.setItem(recordKey(), id); }
function getCachedRecordId(){ return sessionStorage.getItem(recordKey()); }
function resetSession(){
  sessionStorage.removeItem(sessionKey());
  sessionStorage.removeItem(recordKey());
  setSID();
  log('Session reset. You can Create or Upsert again.');
}

/*** Airtable low-level ***/
function headers(){
  return {
    'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  };
}
function baseUrl(){
  const tableInput = ($('#tableName')?.value || 'Lead Magnet Form').trim() || 'Lead Magnet Form';
  return `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(tableInput)}`;
}

async function req(method, url, body){
  const res = await fetch(url, { method, headers: headers(), body: body ? JSON.stringify(body) : undefined });
  const txt = await res.text();
  if(!res.ok){ logErr(`${method} ${res.status} ${res.statusText}\n${txt}`); return { ok:false, text:txt }; }
  try { return { ok:true, json: JSON.parse(txt || '{}') }; }
  catch { return { ok:true, text:txt }; }
}
async function get(url){ return req('GET', url); }
async function post(url, body){ return req('POST', url, body); }
async function patch(url, body){ return req('PATCH', url, body); }

/*** Find/Create/Upsert helpers ***/
async function findRecordBySession(){
  const sid = getSessionId();
  const formula = encodeURIComponent(`{SessionId} = "${sid}"`);
  return await get(`${baseUrl()}?maxRecords=1&filterByFormula=${formula}`);
}

async function ensureRecord(){
  // 1) cache
  const cached = getCachedRecordId();
  if (cached) return cached;

  // 2) find by SessionId
  const f = await findRecordBySession();
  if (f.ok && f.json.records && f.json.records[0]){
    const id = f.json.records[0].id;
    cacheRecordId(id);
    return id;
  }

  // 3) create once (NO SourcePage)
  const c = await post(baseUrl(), { fields:{
    SessionId: getSessionId(),
    Status: 'partial',
    UpdatedAt: new Date().toISOString()
  }});
  if (!c.ok) return null;
  const id = c.json.id;
  cacheRecordId(id);
  return id;
}

/*** Button actions ***/
async function createRow(){
  log('Creating empty row with SessionId…');
  const c = await post(baseUrl(), { fields:{
    SessionId: getSessionId(),
    Status: 'partial',
    UpdatedAt: new Date().toISOString()
  }});
  if (c.ok){ cacheRecordId(c.json.id); logObj('✅ Created', c.json); }
}

async function findBySession(){
  log('Finding by SessionId…');
  const r = await findRecordBySession();
  if(!r.ok) return;
  const rec = r.json.records && r.json.records[0];
  if(rec){ cacheRecordId(rec.id); logObj('✅ Found', rec); }
  else { log('No record found for this SessionId.'); }
}

async function upsertStep1(){
  const first = $('#firstName').value.trim();
  const last  = $('#lastName').value.trim();
  if(!first || !last){ return logErr('Enter First Name and Last Name.'); }

  const id = await ensureRecord();
  if(!id) return;

  log('Patching Step 1 (First/Last)…');
  const r = await patch(`${baseUrl()}/${id}`, { fields:{
    'First Name': first,
    'Last Name':  last,
    Status: 'partial',
    UpdatedAt: new Date().toISOString()
  }});
  if (r.ok) logObj('✅ Step 1 saved', r.json);
}

async function upsertStep2(){
  const email    = $('#email').value.trim();
  const linkedin = $('#linkedin').value.trim();
  if(!email && !linkedin){ return logErr('Enter Email or LinkedIn URL.'); }

  const fields = { Status:'partial', UpdatedAt:new Date().toISOString() };
  if (email)    fields['Email'] = email;
  if (linkedin) fields['LinkedIn'] = linkedin;

  const id = await ensureRecord();
  if(!id) return;

  log('Patching Step 2 (Email/LinkedIn)…');
  const r = await patch(`${baseUrl()}/${id}`, { fields });
  if (r.ok) logObj('✅ Step 2 saved', r.json);
}

async function upsertStep3(){
  const phone = $('#whatsapp').value.trim();
  if(!phone){ return logErr('Enter WhatsApp in E.164 (e.g., +61412345678).'); }

  const id = await ensureRecord();
  if(!id) return;

  log('Patching Step 3 (WhatsApp)…');
  const r = await patch(`${baseUrl()}/${id}`, { fields:{
    'WhatsApp': phone,
    Status: 'partial',
    UpdatedAt: new Date().toISOString()
  }});
  if (r.ok) logObj('✅ Step 3 saved', r.json);
}

async function upsertFinal(){
  const applying = $('#applying').value;
  if(applying === '') return logErr('Choose Currently Applying? (Yes/No).');

  const yes = (applying === 'true');
  const jobs = $('#jobsApplying').value.trim();
  const curr = $('#currentJob').value.trim();

  const fields = {
  'Currently Applying?': yes ? 'Yes' : 'No',
  'Jobs Applying': yes ? jobs : '',
  'Current Job': yes ? '' : curr,
  Status: 'final',
  UpdatedAt: new Date().toISOString()
};

  const id = await ensureRecord();
  if(!id) return;

  log('Patching Final (status + applying + jobs/current)…');
  const r = await patch(`${baseUrl()}/${id}`, { fields });
  if (r.ok) logObj('✅ Final saved', r.json);
}

/*** Wire UI (expects elements with these IDs to exist) ***/
(function wire(){
  const btnCreate = document.getElementById('btnCreate');
  const btnFind   = document.getElementById('btnFind');
  const btnReset  = document.getElementById('btnReset');
  const btnS1     = document.getElementById('btnStep1');
  const btnS2     = document.getElementById('btnStep2');
  const btnS3     = document.getElementById('btnStep3');
  const btnFin    = document.getElementById('btnFinal');

  if(btnCreate) btnCreate.addEventListener('click', createRow);
  if(btnFind)   btnFind.addEventListener('click', findBySession);
  if(btnReset)  btnReset.addEventListener('click', resetSession);

  if(btnS1) btnS1.addEventListener('click', upsertStep1);
  if(btnS2) btnS2.addEventListener('click', upsertStep2);
  if(btnS3) btnS3.addEventListener('click', upsertStep3);
  if(btnFin) btnFin.addEventListener('click', upsertFinal);

  setSID();
})();
</script>