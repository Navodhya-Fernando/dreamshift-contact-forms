<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">

<link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />
<script src="https://assets.calendly.com/assets/external/widget.js" async></script>

<div class="ds-contact-container">
  <div class="progress-container">
    <div class="progress-step active" id="p1">1</div>
    <div class="progress-step" id="p2">2</div>
    <div class="progress-step" id="p3">3</div>
    <div class="progress-step" id="p4">4</div>
    <div class="progress-step" id="p5">5</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  </div>

  <div class="form-container">
    
    <div class="form-step active" id="step1">
      <div class="form-group">
        <label for="name"><strong>Your Name</strong></label>
        <input type="text" id="name" placeholder="George Wilson">
      </div>
      <div class="btn-container">
        <div></div>
        <button class="btn-next" onclick="nextStep(1)">Next</button>
      </div>
    </div>

    <div class="form-step" id="step2">
      <div class="form-group">
        <label for="jobs"><strong>Job(s) you’re looking to apply</strong></label>
        <textarea id="jobs" rows="3" placeholder="Business Analyst, Accountant, Healthcare Professional"></textarea>
      </div>
      <div class="btn-container">
        <button class="btn-prev" onclick="prevStep(2)">Previous</button>
        <button class="btn-next" onclick="nextStep(2)">Next</button>
      </div>
    </div>

    <div class="form-step" id="step3">
      <div class="form-group">
        <label for="whatsApp"><strong>Your WhatsApp Number</strong></label>
        <input type="tel" id="whatsApp" class="lg" placeholder="07XXXXXXXXX">
        <div class="hint" style="font-size:13px;">We will contact you via WhatsApp</div>
      </div>
      <div class="btn-container">
        <button class="btn-prev" onclick="prevStep(3)">Previous</button>
        <button class="btn-next" onclick="nextStep(3)">Next</button>
      </div>
    </div>

    <div class="form-step" id="step4">
      <div class="form-group">
        <label><strong>Choose a package</strong></label>
        <div class="nhs-options" id="pkgWrap"></div>
        
        <div id="bookBtnContainer" style="margin-top:25px; display:none;">
            <button class="btn-primary" onclick="processPaidFlow()">Book your free call</button>
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin: 30px 0;">

        <button class="btn-low-budget" onclick="processLowBudgetFlow()">
            Unfortunately, I am not in a position to invest this much
        </button>

      </div>
      <div class="btn-container">
        <button class="btn-prev" onclick="prevStep(4)">Previous</button>
        <div></div> </div>
    </div>

    <div class="form-step" id="step5">
      <div class="form-group">
        <h3 style="color:#fff; margin-bottom:6px; font-weight:700;">Congratulations!</h3>
        <h4 style="color:#ffe8a8; margin-bottom:14px;">It’s time to book your call.</h4>
        <div class="calendly-inline-widget" 
             data-url="https://calendly.com/dreamshiftcareers/dreamshift-consultation-call-web" 
             style="min-width:320px;height:700px;"></div>
        </div>
    </div>

  </div>
</div>

<div id="ds-secure-popup" class="dreamshift-popup-container" style="display:none;">
  <div class="dreamshift-popup-content">
    <span class="dreamshift-close-btn">&times;</span>
    
    <h2 class="dreamshift-title">Don't Worry!</h2>
    <p class="dreamshift-subtitle">Here is a Free Gift for you!</p>
    
    <div class="dreamshift-image">
      <img src="https://dreamshift.net/wp-content/uploads/2025/09/Australian-Job-Search-Toolkit-We-analysed-100-Successful-Job-Seekers-in-Australia-and-turned-it-into-a-step-by-step-guide.jpg" 
           alt="Job Search Toolkit">
    </div>
    
    <div class="dreamshift-cta">
      <a href="https://dreamshift.net/australia" class="dreamshift-button">Get Your Free Gift</a>
    </div>
  </div>
</div>

<style>
  /* --- MAIN FORM CSS --- */
  .ds-contact-container { background:#24101a; border-radius:15px; width:1000px; max-width:100%; overflow:hidden; margin:0 auto; font-family:'Poppins',sans-serif; }
  .progress-container { display:flex; justify-content:space-between; padding:20px 40px; position:relative; }
  .progress-step { width:30px; height:30px; border-radius:50%; background:#e0e0e0; display:flex; justify-content:center; align-items:center; font-weight:700; z-index:2; color:#24101a; font-family:'Poppins',sans-serif; }
  .progress-step.active { background:#411c30; color:#fff; }
  .progress-step.completed { background:#f6b900; color:#24101a; }
  .progress-bar { position:absolute; height:4px; background:#e0e0e0; top:33px; left:40px; right:40px; z-index:1; }
  .progress-fill { height:100%; background:#f6b900; width:0%; transition:width .5s ease; }

  .form-container { padding:30px; }
  .form-step { display:none; }
  .form-step.active { display:block; animation:fadeIn 0.5s ease; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

  .form-group { margin-bottom:30px; text-align:center; }
  .form-group label { display:block; margin-bottom:15px; font-weight:500; color:#fff; font-size:18px; }
  .form-group input, .form-group textarea { width:100%; padding:15px; border:2px solid #ddd; border-radius:17px; font-size:16px; transition:border .3s ease; text-align:center; max-width:420px; margin:0 auto; display:block; color:#24101a; background:#fff; font-family:'Poppins',sans-serif; }
  .form-group input:focus, .form-group textarea:focus { border-color:#411c30; outline:none; }
  .hint{ color:#ffe8a8; margin-top:8px; }

  .btn-container { display:flex; justify-content:space-between; margin-top:30px; gap:12px; flex-wrap:wrap; }
  .btn-prev, .btn-next, .btn-primary, .btn-low-budget { font-family:'Poppins',sans-serif; }
  
  .btn-prev { padding:12px 25px; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; background:#ffe590; color:#411c30; }
  .btn-prev:hover { background:#f6b900; }
  
  .btn-next { padding:12px 25px; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; background:#f6b900; color:#411c30; }
  .btn-next:hover { background:#ffe590; }

  .btn-primary { width:100%; max-width:260px; padding:15px 25px; border:none; border-radius:8px; font-size:18px; font-weight:700; cursor:pointer; background:#f6b900; color:#411c30; box-shadow: 0 4px 15px rgba(246, 185, 0, 0.3); }
  .btn-primary:hover { background:#ffe590; transform:translateY(-2px); transition:all 0.2s; }

  /* LOW BUDGET BUTTON */
  .btn-low-budget { 
      width:100%; max-width:500px; margin:0 auto; padding:15px; 
      border: 2px solid #ffffff; border-radius:8px; 
      font-size:14px; font-weight: 600; cursor:pointer; 
      background:rgba(255,255,255,0.05); color:#fff; 
      display:block; transition:all 0.3s; 
  }
  .btn-low-budget:hover { 
      background:rgba(255,255,255,0.25); color:#fff; 
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
  }

  .nhs-options { display:flex; gap:15px; justify-content:center; flex-wrap:wrap; }
  .pkg-btn { flex:1; text-align:center; padding:15px; border:2px solid #ddd; border-radius:17px; cursor:pointer; transition:all .3s ease; max-width:260px; color:#411c30; background:#fff; font-family:'Poppins',sans-serif; }
  .pkg-btn:hover { border-color:#411c30; }
  .pkg-btn.active { border-color:#411c30; background:#f6b900; }

  .ds-contact-container input::placeholder,
  .ds-contact-container textarea::placeholder { color:#f6b900 !important; opacity:1 !important; }

  .iti { display:block; margin:0 auto; max-width:420px; font-family:'Poppins',sans-serif; }
  .iti--separate-dial-code .iti__selected-dial-code { font-family:'Poppins',sans-serif; font-weight:600; }
  .iti input { text-align:left !important; padding-left:86px !important; font-family:'Poppins',sans-serif; }

  /* --- POPUP CSS --- */
  #ds-secure-popup {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    /* display:none handled inline to prevent FOUC */
    justify-content: center; align-items: center;
    z-index: 9999999;
    font-family: 'Inter', sans-serif;
  }
  
  /* FORCE visible when active */
  #ds-secure-popup.active { 
    display: flex !important; 
    animation: fadeInPopup 0.3s ease-out; 
  }
  
  @keyframes fadeInPopup { from{opacity:0;} to{opacity:1;} }

  .dreamshift-popup-content {
    background: white; padding: 40px 30px; border-radius: 12px;
    max-width: 450px; width: 90%; text-align: center;
    position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  }

  .dreamshift-close-btn {
    position: absolute; top: 15px; right: 20px;
    font-size: 24px; font-weight: bold; color: #333;
    cursor: pointer; background: none; border: none; line-height: 1;
  }

  .dreamshift-title { font-size: 28px; font-weight: 700; color: #333; margin: 0 0 10px 0; line-height: 1.2; }
  .dreamshift-subtitle { font-size: 16px; color: #666; margin: 0 0 25px 0; line-height: 1.4; }
  
  .dreamshift-image { margin: 0 0 25px 0; }
  .dreamshift-image img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

  .dreamshift-button {
    background: #f6b900; color: #24101a; padding: 14px 28px;
    border-radius: 8px; text-decoration: none; font-weight: 600;
    font-size: 16px; display: inline-block; transition: all 0.3s ease;
    border: none; cursor: pointer;
  }
  .dreamshift-button:hover { background: #e5ab00; transform: translateY(-2px); }

  @media (max-width:600px){
    .ds-contact-container{ margin:10px; }
    .form-container{ padding:20px; }
    .progress-container{ padding:20px; }
    .progress-bar{ left:20px; right:20px; }
    .nhs-options{ flex-direction:column; align-items:center; }
    .pkg-btn{ width:100%; max-width:260px; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" defer></script>

<script>
/* ===== AIRTABLE CONFIG ===== */
const AIRTABLE_API_KEY = 'patKhu6Mk04jcXvAw.87cfbb10e336f1b753651743ee7ca8d9bff68057173264af2437aad9770469ef';
const AIRTABLE_BASE_ID = 'appUH4eBIBnH4D0fX';
const TABLE_MAIN       = 'Contact Form Submissions';
const TABLE_LEAD       = 'Lead Magnet Form';

/* ===== PAGE CONFIG ===== */
const COUNTRY_CODE = 'UK'; // Changed to UK to separate cache from Australia form
const PACKAGE_PRICES = { essential: '£125', advanced: '£150', ultimate: '£300'};

/* ===== STATE ===== */
const state = { name:'', jobs:'', whatsapp:'', pkgId:'', pkgLabel:'' };
const firstStep = 1, lastStep = 5; 
let currentStep = 1;

/* ---- Session + Record cache ---- */
function getSessionId() {
  const KEY = `ds_session_${COUNTRY_CODE}`;
  let id = sessionStorage.getItem(KEY);
  if (!id) { id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random())); sessionStorage.setItem(KEY, id); }
  return id;
}
const REC_KEY = `ds_airtable_rec_${COUNTRY_CODE}`;
function getCachedRecordId(){ return sessionStorage.getItem(REC_KEY) || null; }
function setCachedRecordId(id){ sessionStorage.setItem(REC_KEY, id); }

/* ---- Airtable helpers ---- */
function atHeaders(){ return {'Authorization':`Bearer ${AIRTABLE_API_KEY}`,'Content-Type':'application/json','Accept':'application/json'}; }
function atUrl(tableName){ return `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(tableName)}`; }

async function findRecordBySession(){
  const sessionId = getSessionId();
  const formula = encodeURIComponent(`{SessionId} = "${sessionId}"`);
  const res = await fetch(`${atUrl(TABLE_MAIN)}?maxRecords=1&filterByFormula=${formula}`, { headers: atHeaders() });
  if (!res.ok){ return null; }
  const data = await res.json();
  return (data.records && data.records[0]) ? data.records[0] : null;
}

// Ensure record exists in MAIN table
async function ensureRecord(){
  const cached = getCachedRecordId();
  if (cached) return cached;
  const existing = await findRecordBySession();
  if (existing){ setCachedRecordId(existing.id); return existing.id; }
  const payload = {
    fields: { SessionId: getSessionId(), SourcePage: location.pathname || '/contact-uk', Status: 'partial', UpdatedAt: new Date().toISOString() }
  };
  const res = await fetch(atUrl(TABLE_MAIN), { method:'POST', headers: atHeaders(), body: JSON.stringify(payload) });
  if (!res.ok) return null;
  const data = await res.json();
  const recId = data.id;
  if (recId) setCachedRecordId(recId);
  return recId;
}

// Update MAIN table
async function patchRecord(fields){
  const recId = await ensureRecord();
  if (!recId) return false;
  const merged = Object.assign({}, fields, { UpdatedAt: new Date().toISOString() });
  await fetch(`${atUrl(TABLE_MAIN)}/${recId}`, {
    method:'PATCH', headers: atHeaders(), body: JSON.stringify({ fields: merged })
  });
}

// Submit to LEAD MAGNET table
async function submitToLeadMagnet(){
    const payload = {
        fields: {
            "SessionId": getSessionId(),
            "Name": state.name,
            "WhatsApp": state.whatsapp,
            "Jobs Applying": state.jobs,     
            "Status": "final",
            "UpdatedAt": new Date().toISOString()
        }
    };
    await fetch(atUrl(TABLE_LEAD), { method:'POST', headers: atHeaders(), body: JSON.stringify(payload) });
}

/* ---- UI helpers ---- */
function updateProgress(){
  const pct = ((currentStep - 1) / (lastStep - 1)) * 100;
  document.getElementById('progress-fill').style.width = pct + '%';
  for (let i = firstStep; i <= lastStep; i++){
    const el = document.getElementById('p'+i);
    if (!el) continue;
    el.classList.remove('active','completed');
    if (i < currentStep) el.classList.add('completed');
    if (i === currentStep) el.classList.add('active');
  }
}
function showStep(n){
  for (let i = firstStep; i <= lastStep; i++){
    const s = document.getElementById('step'+i);
    if (s) s.classList.toggle('active', i === n);
  }
  currentStep = n; updateProgress();
}

/* ---- Phone ---- */
let iti = null;
function initPhone(){
  const input = document.getElementById('whatsApp');
  if (!input) return;
  iti = window.intlTelInput(input, {
    initialCountry: 'gb', // UK DEFAULT
    preferredCountries: ['lk','in','au','us','pk'],
    separateDialCode: true,
    nationalMode: true,
    utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js'
  });
}

/* ---- Flow Logic ---- */
async function nextStep(step){
  // Step 1: Name
  if (step === 1){
    const v = document.getElementById('name').value.trim(); 
    if (!v){ alert('Please enter your name'); return; }
    state.name = v;
    await patchRecord({ Name: state.name, Status:'partial' });
  }
  
  // Step 2: Jobs
  if (step === 2){
    state.jobs = (document.getElementById('jobs').value || '').trim();
    if (!state.jobs) { alert('Please list at least one job'); return; }
    await patchRecord({ Jobs: state.jobs, Status:'partial' });
  }

  // Step 3: WhatsApp (Shifted from 4, Location is gone)
  if (step === 3){
    if (!iti || !iti.isValidNumber()){ alert('Please enter a valid WhatsApp number'); return; }
    state.whatsapp = iti.getNumber();
    await patchRecord({ WhatsApp: state.whatsapp, Status:'partial' });
  }

  showStep(Math.min(step + 1, lastStep));
}

function prevStep(step){ showStep(Math.max(step - 1, firstStep)); }

/* ---- Package & Final Submission ---- */
function pkgSelect(id,label){
  state.pkgId = id; state.pkgLabel = label;
  
  // Highlight UI
  document.querySelectorAll('.pkg-btn').forEach(b => b.classList.remove('active'));
  const el = document.querySelector(`[data-pkg="${id}"]`); 
  if (el) el.classList.add('active');

  // Show "Book Call" button
  document.getElementById('bookBtnContainer').style.display = 'block';
}

function buildPackages(){
  const wrap = document.getElementById('pkgWrap');
  wrap.innerHTML = `
    <button class="pkg-btn" data-pkg="essential" onclick="pkgSelect('essential','Essential')">
      <div class="pkg-title"><strong>Essential</strong></div>
      <div class="pkg-price">${PACKAGE_PRICES.essential}</div>
    </button>
    <button class="pkg-btn" data-pkg="advanced" onclick="pkgSelect('advanced','Advanced')">
      <div class="pkg-title"><strong>Advanced</strong></div>
      <div class="pkg-price">${PACKAGE_PRICES.advanced}</div>
    </button>
    <button class="pkg-btn" data-pkg="ultimate" onclick="pkgSelect('ultimate','Ultimate')">
      <div class="pkg-title"><strong>Ultimate</strong></div>
      <div class="pkg-price">${PACKAGE_PRICES.ultimate}</div>
    </button>
  `;
}

// FLOW A: Paid -> Contact Form Table -> Embed Calendly (Step 5)
async function processPaidFlow(){
    if(!state.pkgId) { alert('Please select a package'); return; }
    
    const btn = document.querySelector('.btn-primary');
    btn.innerHTML = 'Loading Calendar...';
    btn.disabled = true;

    // Update Main Table
    await patchRecord({ Package: state.pkgLabel, Status:'final' });
    
    // Move to Step 5 (Embedded Calendar)
    showStep(5);
}

// FLOW B: Low Budget -> Lead Magnet Table -> Custom Popup
async function processLowBudgetFlow(){
    const btn = document.querySelector('.btn-low-budget');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Processing...';
    btn.disabled = true;

    // 1. Submit to Airtable
    try { await submitToLeadMagnet(); } catch(e) { console.error("Airtable Error", e); }

    // 2. Open Custom Popup (Triggered via click ONLY)
    // NOTE: Using the SECURE ID 'ds-secure-popup'
    const popup = document.getElementById('ds-secure-popup');
    if(popup) {
        popup.classList.add('active');
    } else {
        console.error("Popup ID not found");
    }

    // Reset button
    btn.innerHTML = originalText;
    btn.disabled = false;
}

// Popup Logic (Listeners only)
document.addEventListener('DOMContentLoaded', () => {
  initPhone(); buildPackages(); updateProgress();

  const popup = document.getElementById('ds-secure-popup');
  
  if(popup) {
      const closeBtn = popup.querySelector('.dreamshift-close-btn');

      // Close functionality
      if(closeBtn) {
          closeBtn.addEventListener('click', function() {
            popup.classList.remove('active');
          });
      }

      // Close when clicking outside
      popup.addEventListener('click', function(e) {
        if (e.target === popup) {
          popup.classList.remove('active');
        }
      });
  }
});
</script>